# Arrmate — docker-compose.full.yml
#
# FULL STACK — Arrmate + Ollama + Sonarr + Radarr bundled together.
# Useful for a fresh install where you don't yet have any *arr services.
#
# For most users: use docker-compose.yml (or docker-compose.prod.yml)
# and point Arrmate at your existing services instead.
#
# GPU ACCELERATION:
#   COMPOSE_FILE=docker-compose.full.yml:docker-compose.ollama-nvidia.yml
#   COMPOSE_FILE=docker-compose.full.yml:docker-compose.ollama-amd.yml

services:

  # ─────────────────────────────────────────────
  # Arrmate
  # ─────────────────────────────────────────────
  arrmate:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arrmate
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=${API_PORT:-8000}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LLM_PROVIDER=ollama
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5:7b}
      # Services use Docker service names as hostnames
      - SONARR_URL=http://sonarr:8989
      - SONARR_API_KEY=${SONARR_API_KEY:-}
      - RADARR_URL=http://radarr:7878
      - RADARR_API_KEY=${RADARR_API_KEY:-}
      # Add more services from .env.example as needed
      - LIDARR_URL=${LIDARR_URL:-}
      - LIDARR_API_KEY=${LIDARR_API_KEY:-}
      - BAZARR_URL=${BAZARR_URL:-}
      - BAZARR_API_KEY=${BAZARR_API_KEY:-}
      - PLEX_URL=${PLEX_URL:-}
      - PLEX_TOKEN=${PLEX_TOKEN:-}
    networks:
      - arrmate-net
    depends_on:
      - ollama
      - sonarr
      - radarr
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ─────────────────────────────────────────────
  # Ollama — Local LLM (CPU by default)
  # ─────────────────────────────────────────────
  ollama:
    image: ollama/ollama:latest
    container_name: arrmate-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - arrmate-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ─────────────────────────────────────────────
  # Sonarr — TV Show Management
  # ─────────────────────────────────────────────
  sonarr:
    image: linuxserver/sonarr:latest
    container_name: arrmate-sonarr
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
    ports:
      - "8989:8989"
    volumes:
      - sonarr-config:/config
      - sonarr-tv:/tv
      - sonarr-downloads:/downloads
    networks:
      - arrmate-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ─────────────────────────────────────────────
  # Radarr — Movie Management
  # ─────────────────────────────────────────────
  radarr:
    image: linuxserver/radarr:latest
    container_name: arrmate-radarr
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
    ports:
      - "7878:7878"
    volumes:
      - radarr-config:/config
      - radarr-movies:/movies
      - radarr-downloads:/downloads
    networks:
      - arrmate-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s


networks:
  arrmate-net:
    name: arrmate-net

volumes:
  ollama-data:
  sonarr-config:
  sonarr-tv:
  sonarr-downloads:
  radarr-config:
  radarr-movies:
  radarr-downloads:
